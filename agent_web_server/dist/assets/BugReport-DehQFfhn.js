import{g as w}from"./index-DiZwQw_Q.js";import{u as ie}from"./useLazyLoad-CF_UHKIQ.js";import{_ as ne,u as re,j as oe,c as z,d as a,w as l,e as t,N as d,a4 as de,k as pe,r as T,f as g,b as i,C as ce,D as U,a1 as O,S as fe,a5 as B,a8 as N,l as ve,m as ge,n as $,H as ye,x as V,y as p,i as o,t as r,v as y,p as j,q as S,F as me,z as _e,s as x,a9 as be,B as b,O as A,P as m}from"./index-9-2YgmGC.js";const xe={class:"bug-report-view"},ke={style:{"margin-top":"20px",display:"flex","justify-content":"flex-end"}},we={key:0},ze={class:"flex items-center justify-between"},Be={class:"bug-description",style:{"white-space":"pre-line"}},Ne={class:"bug-steps"},Se={class:"json-output"},he={__name:"BugReport",setup(Ce){const _=re(),L=oe(),f=A({total:0,critical:0,open:0,fixed:0}),E=s=>{f.total=s.length,f.critical=s.filter(e=>e.severity_level==="一级"||e.severity_level==="二级").length,f.open=s.filter(e=>["open","in_progress","待处理","已确认","处理中"].includes(e.status)).length,f.fixed=s.filter(e=>["fixed","closed","已修复","已关闭"].includes(e.status)).length},v=A({severity:null,status:null,search:""}),G=async s=>{const e=await w.getList(s);return e.success?(E(e.data||[]),{success:!0,data:e.data||[],total:e.total||(e.data?e.data.length:0)}):e},{data:J,loading:q,currentPage:h,pageSize:C,total:H,refresh:W,goToPage:K,changePageSize:Q}=ie({fetchFunction:G,pageSize:10,filters:v,autoLoad:!0,debounceDelay:500}),D=s=>{typeof s=="number"?K(s):W()},X=[{label:"全部",value:null},{label:"一级（致命）",value:"一级"},{label:"二级（严重）",value:"二级"},{label:"三级（一般）",value:"三级"},{label:"四级（轻微）",value:"四级"}],Y=[{label:"全部",value:null},{label:"待处理",value:"待处理"},{label:"已确认",value:"已确认"},{label:"已修复",value:"已修复"},{label:"已关闭",value:"已关闭"}],k=T(!1),M=T(!1),u=T(null),P=s=>({一级:"error",二级:"warning",三级:"info",四级:"default"})[s]||"default",Z=s=>({功能测试:"info",接口测试:"warning",单元测试:"success",性能测试:"error",安全测试:"error"})[s]||"default",R=s=>({open:"warning",in_progress:"info",fixed:"success",closed:"default",待处理:"warning",已确认:"info",处理中:"info",已修复:"success",已关闭:"default"})[s]||"default",I=s=>({open:"待处理",in_progress:"处理中",fixed:"已修复",closed:"已关闭",待处理:"待处理",已确认:"已确认",处理中:"处理中",已修复:"已修复",已关闭:"已关闭"})[s]||s||"-",ee=[{title:"ID",key:"id",width:80},{title:"Bug 标题",key:"bug_name",width:250,ellipsis:{tooltip:!0}},{title:"测试类型",key:"case_type",width:110,render(s){const e=s.case_type||"功能测试";return m(y,{type:{功能测试:"info",接口测试:"warning",单元测试:"success",性能测试:"error",安全测试:"error"}[e]||"default",size:"small"},{default:()=>e})}},{title:"执行模式",key:"execution_mode",width:90,render(s){const e=s.execution_mode||"单量";return m(y,{type:e==="批量"?"warning":"default",size:"small"},{default:()=>e})}},{title:"严重程度",key:"severity_level",width:100,render(s){return m(y,{type:P(s.severity_level),size:"small"},{default:()=>s.severity_level||"-"})}},{title:"状态",key:"status",width:90,render(s){return m(y,{type:R(s.status),size:"small"},{default:()=>I(s.status)})}},{title:"关联用例",key:"test_case_id",width:100,render(s){return s.test_case_id?`用例 #${s.test_case_id}`:"-"}},{title:"发现时间",key:"created_at",width:160},{title:"操作",key:"actions",width:200,fixed:"right",render(s){return m(j,{},{default:()=>[m(b,{size:"small",type:"primary",onClick:()=>te(s)},{default:()=>"查看详情"}),m(b,{size:"small",type:s.status==="fixed"?"default":"success",disabled:s.status==="fixed",onClick:()=>F(s,"fixed")},{default:()=>"已修复"}),m(b,{size:"small",type:"error",onClick:()=>se(s)},{default:()=>"删除"})]})}}],te=async s=>{k.value=!0,M.value=!0;try{const e=await w.getDetail(s.id);e.success?u.value=e.data:u.value=s}catch{u.value=s}finally{M.value=!1}},le=s=>({open:"待处理",in_progress:"已确认",fixed:"已修复",closed:"已关闭"})[s],F=async(s,e)=>{const n=le(e);try{const c=await w.updateStatus(s.id,n);c.success?(_.success("状态更新成功"),D()):_.error(c.message||"更新失败")}catch(c){_.error("更新失败"),console.error(c)}},ae=()=>{u.value&&L.success({title:"确认修复",content:"确定要将此 Bug 标记为已修复吗？",positiveText:"确定",negativeText:"取消",onPositiveClick:async()=>{await F(u.value,"fixed"),u.value.status="已修复"}})},se=s=>{L.warning({title:"确认删除",content:`确定要删除 Bug "${s.title}" 吗？`,positiveText:"确定",negativeText:"取消",onPositiveClick:async()=>{try{const e=await w.delete(s.id);e.success?(_.success("删除成功"),D()):_.error(e.message||"删除失败")}catch(e){_.error("删除失败"),console.error(e)}}})},ue=()=>{if(!u.value)return;const s=JSON.stringify(u.value,null,2),e=new Blob([s],{type:"application/json"}),n=URL.createObjectURL(e),c=document.createElement("a");c.href=n,c.download=`bug_report_${u.value.id}.json`,c.click(),URL.revokeObjectURL(n),_.success("报告下载成功")};return(s,e)=>(g(),z("div",xe,[a(t(d),null,{header:l(()=>[...e[7]||(e[7]=[i("div",{class:"flex items-center gap-2"},[i("i",{class:"fas fa-bug text-xl text-primary"}),i("span",{class:"text-lg font-bold"},"Bug 测试报告")],-1)])]),default:l(()=>[e[8]||(e[8]=i("p",{class:"text-gray-500"}," 管理测试执行过程中发现的 Bug，包括 Bug 详情、严重程度、处理状态等 ",-1))]),_:1}),a(t(d),{style:{"margin-top":"20px"}},{default:l(()=>[a(t(ce),{inline:"",model:v,"label-placement":"left"},{default:l(()=>[a(t(U),{label:"严重程度"},{default:l(()=>[a(t(O),{value:v.severity,"onUpdate:value":e[0]||(e[0]=n=>v.severity=n),options:X,clearable:"",placeholder:"全部",style:{width:"120px"}},null,8,["value"])]),_:1}),a(t(U),{label:"状态"},{default:l(()=>[a(t(O),{value:v.status,"onUpdate:value":e[1]||(e[1]=n=>v.status=n),options:Y,clearable:"",placeholder:"全部",style:{width:"120px"}},null,8,["value"])]),_:1}),a(t(U),{label:"搜索"},{default:l(()=>[a(t(fe),{value:v.search,"onUpdate:value":e[2]||(e[2]=n=>v.search=n),placeholder:"搜索 Bug 标题或描述",clearable:""},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1}),a(t(de),{cols:4,"x-gap":20,style:{"margin-top":"20px"}},{default:l(()=>[a(t(B),null,{default:l(()=>[a(t(d),{size:"small",class:"stat-card"},{default:l(()=>[a(t(N),{label:"总计",value:f.total},{prefix:l(()=>[...e[9]||(e[9]=[i("i",{class:"fas fa-bug"},null,-1)])]),_:1},8,["value"])]),_:1})]),_:1}),a(t(B),null,{default:l(()=>[a(t(d),{size:"small",class:"stat-card stat-critical"},{default:l(()=>[a(t(N),{label:"严重",value:f.critical},{prefix:l(()=>[...e[10]||(e[10]=[i("i",{class:"fas fa-exclamation-circle"},null,-1)])]),_:1},8,["value"])]),_:1})]),_:1}),a(t(B),null,{default:l(()=>[a(t(d),{size:"small",class:"stat-card stat-open"},{default:l(()=>[a(t(N),{label:"待处理",value:f.open},{prefix:l(()=>[...e[11]||(e[11]=[i("i",{class:"fas fa-clock"},null,-1)])]),_:1},8,["value"])]),_:1})]),_:1}),a(t(B),null,{default:l(()=>[a(t(d),{size:"small",class:"stat-card stat-fixed"},{default:l(()=>[a(t(N),{label:"已修复",value:f.fixed},{prefix:l(()=>[...e[12]||(e[12]=[i("i",{class:"fas fa-check-circle"},null,-1)])]),_:1},8,["value"])]),_:1})]),_:1})]),_:1}),a(t(d),{style:{"margin-top":"20px"}},{header:l(()=>[...e[13]||(e[13]=[i("span",{class:"font-bold"},"Bug 列表",-1)])]),default:l(()=>[a(t(ve),{columns:ee,data:t(J),loading:t(q),"row-key":n=>n.id,striped:""},null,8,["data","loading","row-key"]),i("div",ke,[a(t(ge),{page:t(h),"onUpdate:page":[e[3]||(e[3]=n=>$(h)?h.value=n:null),D],"page-size":t(C),"onUpdate:pageSize":[e[4]||(e[4]=n=>$(C)?C.value=n:null),t(Q)],"item-count":t(H),"page-sizes":[10,20,50],"show-size-picker":""},null,8,["page","page-size","item-count","onUpdate:pageSize"])])]),_:1}),a(t(pe),{show:k.value,"onUpdate:show":e[6]||(e[6]=n=>k.value=n),preset:"card",title:"Bug 详情",style:{width:"900px"}},{footer:l(()=>[a(t(j),{justify:"end"},{default:l(()=>[u.value&&u.value.status!=="fixed"?(g(),S(t(b),{key:0,type:"success",onClick:ae},{icon:l(()=>[...e[19]||(e[19]=[i("i",{class:"fas fa-check"},null,-1)])]),default:l(()=>[e[20]||(e[20]=o(" 标记为已修复 ",-1))]),_:1})):x("",!0),a(t(b),{type:"primary",onClick:ue},{icon:l(()=>[...e[21]||(e[21]=[i("i",{class:"fas fa-download"},null,-1)])]),default:l(()=>[e[22]||(e[22]=o(" 下载报告 ",-1))]),_:1}),a(t(b),{onClick:e[5]||(e[5]=n=>k.value=!1)},{default:l(()=>[...e[23]||(e[23]=[o("关闭",-1)])]),_:1})]),_:1})]),default:l(()=>[a(t(ye),{show:M.value},{default:l(()=>[u.value?(g(),z("div",we,[a(t(d),{size:"small",style:{"margin-bottom":"20px"}},{header:l(()=>[i("div",ze,[i("span",null,[i("strong",null,r(u.value.bug_name),1)]),a(t(j),null,{default:l(()=>[a(t(y),{type:P(u.value.severity_level),size:"small"},{default:l(()=>[o(r(u.value.severity_level),1)]),_:1},8,["type"]),a(t(y),{type:R(u.value.status),size:"small"},{default:l(()=>[o(r(I(u.value.status)),1)]),_:1},8,["type"])]),_:1})])]),default:l(()=>[a(t(V),{column:2,"label-placement":"left",bordered:""},{default:l(()=>[a(t(p),{label:"Bug ID"},{default:l(()=>[o(r(u.value.id),1)]),_:1}),a(t(p),{label:"关联测试用例"},{default:l(()=>[o(r(u.value.test_case_id?`用例 #${u.value.test_case_id}`:"-"),1)]),_:1}),a(t(p),{label:"测试类型"},{default:l(()=>[a(t(y),{type:Z(u.value.case_type),size:"small"},{default:l(()=>[o(r(u.value.case_type||"功能测试"),1)]),_:1},8,["type"])]),_:1}),a(t(p),{label:"执行模式"},{default:l(()=>[a(t(y),{type:u.value.execution_mode==="批量"?"warning":"default",size:"small"},{default:l(()=>[o(r(u.value.execution_mode||"单量"),1)]),_:1},8,["type"])]),_:1}),a(t(p),{label:"发现时间"},{default:l(()=>[o(r(u.value.created_at),1)]),_:1}),a(t(p),{label:"更新时间"},{default:l(()=>[o(r(u.value.updated_at||"-"),1)]),_:1}),a(t(p),{label:"错误类型"},{default:l(()=>[o(r(u.value.error_type||"-"),1)]),_:1}),a(t(p),{label:"定位地址"},{default:l(()=>[o(r(u.value.location_url||"-"),1)]),_:1})]),_:1})]),_:1}),a(t(d),{size:"small",style:{"margin-bottom":"20px"}},{header:l(()=>[...e[14]||(e[14]=[i("strong",null,"问题描述",-1)])]),default:l(()=>[i("div",Be,r(u.value.description||`测试用例【${u.value.bug_name}】执行失败`),1)]),_:1}),u.value.reproduce_steps&&u.value.reproduce_steps.length>0?(g(),S(t(d),{key:0,size:"small",style:{"margin-bottom":"20px"}},{header:l(()=>[...e[15]||(e[15]=[i("strong",null,"复现步骤",-1)])]),default:l(()=>[i("div",Ne,[i("ol",null,[(g(!0),z(me,null,_e(u.value.reproduce_steps,(n,c)=>(g(),z("li",{key:c},r(n),1))),128))])])]),_:1})):x("",!0),u.value.result_feedback?(g(),S(t(d),{key:1,size:"small",style:{"margin-bottom":"20px"}},{header:l(()=>[...e[16]||(e[16]=[i("strong",null,"结果反馈",-1)])]),default:l(()=>[a(t(V),{column:1,"label-placement":"left",bordered:""},{default:l(()=>[a(t(p),{label:"预期结果"},{default:l(()=>[o(r(u.value.expected_result||"-"),1)]),_:1}),a(t(p),{label:"实际结果"},{default:l(()=>[o(r(u.value.actual_result||"-"),1)]),_:1}),a(t(p),{label:"分析"},{default:l(()=>[o(r(u.value.result_feedback),1)]),_:1})]),_:1})]),_:1})):x("",!0),u.value.screenshot_path?(g(),S(t(d),{key:2,size:"small",style:{"margin-bottom":"20px"}},{header:l(()=>[...e[17]||(e[17]=[i("strong",null,"错误截图",-1)])]),default:l(()=>[a(t(be),{src:u.value.screenshot_path,width:"600","object-fit":"contain"},null,8,["src"])]),_:1})):x("",!0),a(t(d),{size:"small"},{header:l(()=>[...e[18]||(e[18]=[i("strong",null,"原始数据",-1)])]),default:l(()=>[i("div",Se,[i("pre",null,r(JSON.stringify(u.value,null,2)),1)])]),_:1})])):x("",!0)]),_:1},8,["show"])]),_:1},8,["show"])]))}},Ue=ne(he,[["__scopeId","data-v-6e9797e9"]]);export{Ue as default};
