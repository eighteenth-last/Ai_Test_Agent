import{m as _,d as le}from"./index-DiZwQw_Q.js";import{_ as ie,u as re,j as oe,o as ne,a as de,c as v,V as ue,b as t,t as d,d as r,w as o,e as i,p as j,H as ce,F as K,z as V,T as w,k as pe,U as Y,r as f,f as c,E as ve,B as k,i as x,v as me,s as z,q as fe,a3 as xe,C as ge,D as S,S as O,a1 as be,G as B,I as ye,O as _e}from"./index-9-2YgmGC.js";const we={class:"model-manage-view"},ke={class:"grid grid-cols-4 gap-5 mb-6"},Se={class:"stat-card-modern bg-gradient-to-br from-green-50 to-emerald-50 border border-green-100 col-span-2"},he={class:"flex items-start justify-between"},Te={class:"flex-1"},Ae={class:"text-2xl font-bold text-slate-800 mt-2 truncate"},Me={class:"text-xs text-slate-500 mt-1"},Ne={class:"stat-card-modern bg-gradient-to-br from-purple-50 to-violet-50 border border-purple-100"},$e={class:"flex items-start justify-between"},Ie={class:"flex-1"},ze={class:"text-2xl font-bold text-slate-800 mt-2"},Ce={class:"stat-card-modern bg-gradient-to-br from-blue-50 to-indigo-50 border border-blue-100"},Ee={class:"flex items-start justify-between"},Pe={class:"flex-1"},je={class:"text-2xl font-bold text-slate-800 mt-2"},Ye={class:"text-xs text-slate-500 mt-1"},Oe={class:"bg-white rounded-xl shadow-sm border border-slate-200"},Ue={class:"p-5 border-b border-slate-200 flex items-center justify-between"},Le={class:"p-5"},Fe={key:0,class:"text-center py-12"},Re={key:1,class:"grid grid-cols-1 gap-5"},Ke={class:"flex items-start justify-between gap-4 mb-4"},Ve={class:"flex items-start gap-3 flex-1 min-w-0"},Be={class:"flex flex-col gap-2 flex-shrink-0"},De={key:0,class:"status-badge-active"},Ge={class:"flex-1 min-w-0"},qe={class:"flex items-center gap-2 mb-2"},He=["title"],We={class:"flex items-center gap-2 text-sm text-slate-500"},Je={key:0,class:"px-2 py-0.5 bg-slate-100 text-slate-600 text-xs rounded"},Qe={class:"grid grid-cols-4 gap-4 pt-4 border-t border-slate-200"},Xe={class:"flex items-center gap-2 mt-2"},Ze={class:"flex-1 h-2 bg-slate-100 rounded-full overflow-hidden"},et={class:"text-sm font-semibold text-slate-700 w-10 text-right"},tt={key:0,class:"text-xs text-red-500 mt-1"},st={class:"text-base font-semibold text-slate-700 mt-2"},at={class:"text-base font-semibold text-slate-700 mt-2"},lt=["title"],it={class:"border-t border-slate-200 bg-slate-50"},rt={class:"p-4"},ot={class:"bg-slate-900 rounded-lg p-4 font-mono text-sm max-h-32 overflow-y-auto"},nt={__name:"ModelManage",setup(dt){const u=re(),D=oe(),m=f([]),C=f(!1),y=f(!1),g=f(!1),E=f(!1),U=f(null),M=f(!0),h=f([]);let P=null;const n=(s,e)=>{h.value.unshift({type:s,message:e}),h.value.length>50&&h.value.pop()},L=async()=>{try{const s=await le.getSystemLogs(20);if(s.success&&Array.isArray(s.data)){const e=s.data.map(p=>{let b="system";return p.level==="ERROR"&&(b="error"),p.level==="WARNING"&&(b="warning"),p.source==="action"&&(b="action"),{type:b,message:`[${p.created_at}] ${p.message}`}});h.value=e}}catch(s){console.error("获取系统日志失败:",s)}},l=_e({id:null,model_name:"",api_key:"",base_url:"",provider:"",priority:1,utilization:100}),T=f([]),G={model_name:{required:!0,message:"请输入模型名称",trigger:"blur"},api_key:{required:!0,message:"请输入 API Key",trigger:"blur"},priority:{required:!0,message:"请设置优先级",trigger:"blur",type:"number"},utilization:{required:!0,message:"请设置利用率",trigger:"blur",type:"number"}},A=Y(()=>m.value.find(s=>s.is_active===1)),q=Y(()=>m.value.reduce((s,e)=>s+(e.tokens_used_total||0),0)),H=Y(()=>m.value.reduce((s,e)=>s+(e.tokens_used_today||0),0)),N=s=>s>=1e6?(s/1e6).toFixed(1)+"M":s>=1e3?(s/1e3).toFixed(1)+"K":s.toString(),W=s=>{u.success(`自动切换已${s?"开启":"关闭"}`),n("action",`[ACTION] 自动切换已${s?"开启":"关闭"}`),console.log("自动切换状态:",s)},J=s=>s===1?"error":s===2?"warning":s===3?"info":"default",Q=async()=>{try{const s=await _.getProviders();console.log("供应商API返回结果:",s),s.success&&Array.isArray(s.data)?(T.value=s.data.map(e=>({label:e.display_name,value:e.code})),console.log("供应商列表已加载:",T.value),n("system",`[SYSTEM] 已加载 ${T.value.length} 个模型供应商`)):(console.warn("供应商数据格式错误:",s),n("system","[SYSTEM] 供应商数据格式错误，使用默认选项"),F())}catch(s){console.error("加载供应商列表失败:",s),n("system",`[SYSTEM] 加载供应商失败: ${s.message}`),F()}},F=()=>{T.value=[{label:"OpenAI",value:"openai"},{label:"Anthropic",value:"anthropic"},{label:"Google (Gemini)",value:"google"},{label:"DeepSeek",value:"deepseek"},{label:"Alibaba (通义千问)",value:"alibaba"},{label:"Baidu (文心一言)",value:"baidu"},{label:"其他",value:"other"}]},$=async()=>{C.value=!0;try{const s=await _.getList();if(Array.isArray(s)){m.value=s,n("system",`[SYSTEM] 模型列表已加载，共 ${m.value.length} 个配置`);const e=m.value.find(p=>p.is_active===1);e&&n("system",`[SYSTEM] 当前激活模型：${e.model_name}`)}else u.error("获取模型列表失败"),n("system","[SYSTEM] 获取模型列表失败，返回数据格式异常")}catch(s){u.error("获取模型列表失败: "+(s.message||"未知错误")),console.error(s),n("system",`[SYSTEM] 获取模型列表失败: ${s.message||"未知错误"}`)}finally{C.value=!1}},X=()=>{g.value=!1,ee(),y.value=!0},Z=s=>{g.value=!0,l.id=s.id,l.model_name=s.model_name,l.api_key=s.api_key,l.base_url=s.base_url||"",l.provider=s.provider||"",l.priority=s.priority,l.utilization=s.utilization,y.value=!0},ee=()=>{l.id=null,l.model_name="",l.api_key="",l.base_url="",l.provider="",l.priority=1,l.utilization=100},te=async()=>{var s;try{await((s=U.value)==null?void 0:s.validate())}catch{return}E.value=!0;try{let e;g.value?e=await _.update(l.id,l):e=await _.add(l),e.success?(u.success(g.value?"更新成功":"添加成功"),y.value=!1,$(),g.value?n("action",`[ACTION] 已更新模型：${l.model_name}`):n("action",`[ACTION] 已添加模型：${l.model_name}`)):(u.error(e.message||"操作失败"),n("system",`[SYSTEM] 模型保存失败: ${e.message||"未知错误"}`))}catch(e){u.error("操作失败: "+(e.message||"未知错误")),console.error(e),n("system",`[SYSTEM] 模型保存异常: ${e.message||"未知错误"}`)}finally{E.value=!1}},se=async s=>{try{const e=await _.activate(s.id);e.success?(u.success(`模型 ${s.model_name} 已激活`),$(),n("action",`[ACTION] 手动切换至模型：${s.model_name}`)):(u.error(e.message||"激活失败"),n("system",`[SYSTEM] 激活模型失败: ${e.message||"未知错误"}`))}catch(e){u.error("激活失败: "+(e.message||"未知错误")),console.error(e),n("system",`[SYSTEM] 激活模型异常: ${e.message||"未知错误"}`)}},ae=s=>{if(s.is_active===1){u.warning("无法删除激活中的模型");return}D.warning({title:"确认删除",content:`确定要删除模型 "${s.model_name}" 吗？`,positiveText:"确定",negativeText:"取消",onPositiveClick:async()=>{try{const e=await _.delete(s.id);e.success?(u.success("删除成功"),$(),n("action",`[ACTION] 已删除模型：${s.model_name}`)):(u.error(e.message||"删除失败"),n("system",`[SYSTEM] 删除模型失败: ${e.message||"未知错误"}`))}catch(e){u.error("删除失败: "+(e.message||"未知错误")),console.error(e),n("system",`[SYSTEM] 删除模型异常: ${e.message||"未知错误"}`)}}})};return ne(()=>{n("system","[SYSTEM] 模型管理控制台已就绪"),Q(),$(),L(),P=setInterval(L,3e3)}),de(()=>{P&&clearInterval(P)}),(s,e)=>{var p,b,R;return c(),v("div",we,[e[37]||(e[37]=ue('<div class="mb-6" data-v-4509c34c><div class="flex items-center gap-3 mb-2" data-v-4509c34c><div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center" data-v-4509c34c><i class="fas fa-brain text-white text-lg" data-v-4509c34c></i></div><div data-v-4509c34c><h1 class="text-2xl font-bold text-slate-800" data-v-4509c34c>模型信息与切换</h1><p class="text-sm text-slate-500" data-v-4509c34c>管理 LLM 模型配置，支持多模型切换策略</p></div></div></div>',1)),t("div",ke,[t("div",Se,[t("div",he,[t("div",Te,[e[9]||(e[9]=t("div",{class:"flex items-center gap-2 mb-1"},[t("div",{class:"w-8 h-8 rounded-lg bg-green-500 flex items-center justify-center"},[t("i",{class:"fas fa-check-circle text-white text-sm"})]),t("span",{class:"text-sm font-medium text-slate-600"},"当前活动模型")],-1)),t("p",Ae,d(((p=A.value)==null?void 0:p.model_name)||"未激活"),1),t("p",Me,d((b=A.value)!=null&&b.provider_display_name||(R=A.value)!=null&&R.provider?`供应商: ${A.value.provider_display_name||A.value.provider}`:"请激活模型"),1)]),e[10]||(e[10]=t("div",{class:"flex items-center justify-center w-12 h-12 rounded-full bg-green-100"},[t("i",{class:"fas fa-robot text-green-600 text-xl"})],-1))])]),t("div",Ne,[t("div",$e,[t("div",Ie,[e[11]||(e[11]=t("div",{class:"flex items-center gap-2 mb-1"},[t("div",{class:"w-8 h-8 rounded-lg bg-purple-500 flex items-center justify-center"},[t("i",{class:"fas fa-database text-white text-sm"})]),t("span",{class:"text-sm font-medium text-slate-600"},"总消耗 TOKEN")],-1)),t("p",ze,d(N(q.value)),1),e[12]||(e[12]=t("p",{class:"text-xs text-slate-500 mt-1"}," 累计消耗 ",-1))]),e[13]||(e[13]=t("div",{class:"flex items-center justify-center w-12 h-12 rounded-full bg-purple-100"},[t("i",{class:"fas fa-chart-area text-purple-600 text-xl"})],-1))])]),t("div",Ce,[t("div",Ee,[t("div",Pe,[e[14]||(e[14]=t("div",{class:"flex items-center gap-2 mb-1"},[t("div",{class:"w-8 h-8 rounded-lg bg-blue-500 flex items-center justify-center"},[t("i",{class:"fas fa-coins text-white text-sm"})]),t("span",{class:"text-sm font-medium text-slate-600"},"今日消耗 TOKEN")],-1)),t("p",je,d(N(H.value)),1),t("p",Ye,d(m.value.length)+" 个模型在线 ",1)]),e[15]||(e[15]=t("div",{class:"flex items-center justify-center w-12 h-12 rounded-full bg-blue-100"},[t("i",{class:"fas fa-chart-line text-blue-600 text-xl"})],-1))])])]),t("div",Oe,[t("div",Ue,[e[19]||(e[19]=t("div",null,[t("h2",{class:"text-lg font-bold text-slate-800"},"模型配置列表"),t("p",{class:"text-sm text-slate-500 mt-1"},"管理和切换 AI 模型")],-1)),r(i(j),null,{default:o(()=>[t("div",{class:w(["flex items-center gap-3 px-4 py-2 rounded-lg border",M.value?"bg-purple-50 border-purple-200":"bg-slate-50 border-slate-200"])},[t("i",{class:w(["fas fa-sync-alt text-sm",M.value?"text-purple-600":"text-slate-400"])},null,2),e[16]||(e[16]=t("div",{class:"flex flex-col"},[t("span",{class:"text-xs text-slate-500"},"自动切换模型"),t("span",{class:"text-xs text-slate-400"},"智能负载均衡")],-1)),r(i(ve),{value:M.value,"onUpdate:value":[e[0]||(e[0]=a=>M.value=a),W],size:"small"},null,8,["value"])],2),r(i(k),{type:"primary",onClick:X},{icon:o(()=>[...e[17]||(e[17]=[t("i",{class:"fas fa-plus"},null,-1)])]),default:o(()=>[e[18]||(e[18]=x(" 添加模型 ",-1))]),_:1})]),_:1})]),r(i(ce),{show:C.value},{default:o(()=>[t("div",Le,[m.value.length===0?(c(),v("div",Fe,[...e[20]||(e[20]=[t("i",{class:"fas fa-inbox text-slate-300 text-5xl mb-4"},null,-1),t("p",{class:"text-slate-500"},"暂无模型配置",-1)])])):(c(),v("div",Re,[(c(!0),v(K,null,V(m.value,a=>(c(),v("div",{key:a.id,class:w(["model-card-modern",{active:a.is_active===1}])},[t("div",Ke,[t("div",Ve,[t("div",Be,[r(i(me),{type:J(a.priority),size:"small",round:""},{default:o(()=>[x(" P"+d(a.priority),1)]),_:2},1032,["type"]),a.is_active===1?(c(),v("span",De,[...e[21]||(e[21]=[t("i",{class:"fas fa-circle text-xs"},null,-1),x(" 活动 ",-1)])])):z("",!0)]),t("div",Ge,[t("div",qe,[t("h3",{class:"text-lg font-bold text-slate-800 truncate",title:a.model_name},d(a.model_name),9,He)]),t("div",We,[a.provider_display_name||a.provider?(c(),v("span",Je,d(a.provider_display_name||a.provider),1)):z("",!0),e[22]||(e[22]=t("span",{class:"text-slate-400"},"|",-1)),t("span",{class:w(a.status==="active"?"text-green-600 font-medium":"")},d(a.status||"idle"),3)])])]),r(i(j),{class:"flex-shrink-0"},{default:o(()=>[a.is_active!==1?(c(),fe(i(k),{key:0,size:"small",type:"success",onClick:I=>se(a)},{icon:o(()=>[...e[23]||(e[23]=[t("i",{class:"fas fa-play"},null,-1)])]),_:1},8,["onClick"])):z("",!0),r(i(k),{size:"small",onClick:I=>Z(a)},{icon:o(()=>[...e[24]||(e[24]=[t("i",{class:"fas fa-edit"},null,-1)])]),_:1},8,["onClick"]),r(i(k),{size:"small",type:"error",onClick:I=>ae(a),disabled:a.is_active===1},{icon:o(()=>[...e[25]||(e[25]=[t("i",{class:"fas fa-trash"},null,-1)])]),_:1},8,["onClick","disabled"])]),_:2},1024)]),t("div",Qe,[t("div",null,[e[26]||(e[26]=t("span",{class:"text-xs text-slate-500"},"利用率额度",-1)),t("div",Xe,[t("div",Ze,[t("div",{class:w(["h-full transition-all duration-300",a.utilization<10?"bg-red-500":a.utilization<30?"bg-orange-500":"bg-green-500"]),style:xe({width:a.utilization+"%"})},null,6)]),t("span",et,d(a.utilization)+"%",1)]),a.utilization<10?(c(),v("p",tt,"即将触发切换")):z("",!0)]),t("div",null,[e[27]||(e[27]=t("span",{class:"text-xs text-slate-500"},"总消耗",-1)),t("p",st,d(N(a.tokens_used_total||0)),1),e[28]||(e[28]=t("p",{class:"text-xs text-slate-400 mt-1"},"tokens",-1))]),t("div",null,[e[29]||(e[29]=t("span",{class:"text-xs text-slate-500"},"今日消耗",-1)),t("p",at,d(N(a.tokens_used_today||0)),1),e[30]||(e[30]=t("p",{class:"text-xs text-slate-400 mt-1"},"tokens",-1))]),t("div",null,[e[31]||(e[31]=t("span",{class:"text-xs text-slate-500"},"API Key",-1)),t("p",{class:"text-sm font-mono text-slate-600 mt-2 truncate",title:a.api_key},d(a.api_key?"••••"+a.api_key.slice(-8):"-"),9,lt),e[32]||(e[32]=t("p",{class:"text-xs text-slate-400 mt-1"},"已加密",-1))])])],2))),128))]))])]),_:1},8,["show"]),t("div",it,[t("div",rt,[e[33]||(e[33]=t("div",{class:"flex items-center gap-2 mb-3"},[t("i",{class:"fas fa-terminal text-slate-600"}),t("span",{class:"font-semibold text-slate-700"},"系统日志")],-1)),t("div",ot,[(c(!0),v(K,null,V(h.value,(a,I)=>(c(),v("p",{key:I,class:w(`log-line log-${a.type}`)},d(a.message),3))),128))])])])]),r(i(pe),{show:y.value,"onUpdate:show":e[8]||(e[8]=a=>y.value=a),preset:"card",title:g.value?"编辑模型":"添加模型",style:{width:"600px"}},{footer:o(()=>[r(i(j),{justify:"end"},{default:o(()=>[r(i(k),{onClick:e[7]||(e[7]=a=>y.value=!1)},{default:o(()=>[...e[36]||(e[36]=[x("取消",-1)])]),_:1}),r(i(k),{type:"primary",onClick:te,loading:E.value},{default:o(()=>[x(d(g.value?"保存":"添加"),1)]),_:1},8,["loading"])]),_:1})]),default:o(()=>[r(i(ge),{ref_key:"formRef",ref:U,model:l,rules:G,"label-placement":"left","label-width":"120"},{default:o(()=>[r(i(S),{label:"模型名称",path:"model_name"},{default:o(()=>[r(i(O),{value:l.model_name,"onUpdate:value":e[1]||(e[1]=a=>l.model_name=a),placeholder:"如：DeepSeek V3, GPT-4"},null,8,["value"])]),_:1}),r(i(S),{label:"API Key",path:"api_key"},{default:o(()=>[r(i(O),{value:l.api_key,"onUpdate:value":e[2]||(e[2]=a=>l.api_key=a),type:"password",placeholder:"请输入 API Key","show-password-on":"click"},null,8,["value"])]),_:1}),r(i(S),{label:"API 基础URL",path:"base_url"},{default:o(()=>[r(i(O),{value:l.base_url,"onUpdate:value":e[3]||(e[3]=a=>l.base_url=a),placeholder:"如：https://api.deepseek.com/v1"},null,8,["value"])]),_:1}),r(i(S),{label:"模型供应商",path:"provider"},{default:o(()=>[r(i(be),{value:l.provider,"onUpdate:value":e[4]||(e[4]=a=>l.provider=a),options:T.value,placeholder:"请选择供应商"},null,8,["value","options"])]),_:1}),r(i(S),{label:"优先级",path:"priority"},{default:o(()=>[r(i(B),{value:l.priority,"onUpdate:value":e[5]||(e[5]=a=>l.priority=a),min:1,max:10,placeholder:"数字越小优先级越高"},null,8,["value"])]),_:1}),r(i(S),{label:"利用率百分比",path:"utilization"},{default:o(()=>[r(i(B),{value:l.utilization,"onUpdate:value":e[6]||(e[6]=a=>l.utilization=a),min:0,max:100,step:1,placeholder:"0-100"},{suffix:o(()=>[...e[34]||(e[34]=[x("%",-1)])]),_:1},8,["value"])]),_:1}),r(i(ye),{title:"配置说明",type:"info",class:"mt-2",bordered:!1},{default:o(()=>[...e[35]||(e[35]=[t("div",{class:"text-xs text-slate-500"},[t("p",{class:"mb-1"},"1. 请完善填写：模型名称、API Key、API 基础URL、模型供应商。"),t("p",null,[x("2. 供应商选择：请选择模型实际归属的厂商。例如使用中转服务调用 ChatGPT，供应商仍应选择 "),t("strong",null,"OpenAI"),x("。")])],-1)])]),_:1})]),_:1},8,["model"])]),_:1},8,["show","title"])])}}},pt=ie(nt,[["__scopeId","data-v-4509c34c"]]);export{pt as default};
