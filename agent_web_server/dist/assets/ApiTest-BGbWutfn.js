import{t as he,b as F}from"./index-DiZwQw_Q.js";import{_ as ke,u as xe,o as be,c,d as n,w as a,e as i,N as z,s as p,r as _,f as u,Q as we,R as I,b as s,S as V,t as o,H as Z,l as ee,B as T,i as d,v as x,F as U,z as D,T as q,x as Se,y as $,g as Ce,h as se,C as Ne,D as te,q as ae,U as ze,P as le}from"./index-9-2YgmGC.js";const Te={class:"api-test-container"},qe={key:0},Be={class:"flex items-center gap-4 mb-4"},Oe={class:"text-gray-400 text-sm"},Pe={key:1},Ee={class:"flex gap-2"},Le={key:0},Ae={class:"match-card recommended"},Re={class:"match-card-header"},Ue={class:"match-info"},De={class:"text-gray-400 text-xs"},$e={key:0,class:"match-reason"},Je={class:"match-stat"},Me={key:0,class:"mt-4"},Fe={class:"candidate-list"},Ie=["onClick"],Ve={class:"match-card-header"},je={class:"match-info"},He={class:"mt-4"},Ge={key:1,class:"text-center py-12 text-gray-400"},Qe={key:2},Ke={class:"flex gap-2"},We={key:0},Xe={class:"endpoint-mapping-list"},Ye={class:"mapping-case"},Ze={class:"mapping-case-id"},es={class:"mapping-case-title"},ss={key:0,class:"mapping-endpoint"},ts={class:"endpoint-path ml-1"},as={class:"endpoint-summary ml-2"},ls={key:1,class:"text-gray-400 text-xs"},is={key:0,class:"text-gray-400 text-sm py-2"},ns={key:1},os={class:"result-summary"},ds={class:"result-stat"},rs={class:"result-stat-value total"},us={class:"result-stat"},cs={class:"result-stat-value pass"},vs={class:"result-stat"},ps={class:"result-stat-value fail"},fs={class:"result-stat"},ms={class:"result-stat-value"},_s={class:"result-stat"},ys={class:"result-stat-value"},gs={class:"flex gap-2 mb-4"},hs=["onClick"],ks={class:"flex items-center gap-3 flex-1 min-w-0"},xs={class:"result-title"},bs={class:"flex items-center gap-4"},ws={class:"result-endpoint"},Ss={class:"text-gray-400 text-xs"},Cs={key:0,class:"result-card-detail"},Ns={class:"detail-section"},zs={class:"detail-row"},Ts={class:"detail-value url"},qs={key:0,class:"detail-row"},Bs={class:"detail-value"},Os={key:1,class:"detail-row"},Ps={class:"detail-json"},Es={key:2,class:"detail-row"},Ls={class:"detail-value text-xs"},As={class:"detail-section"},Rs={class:"detail-row"},Us={key:0,class:"detail-row"},Ds={class:"detail-json"},$s={key:0,class:"detail-section"},Js={class:"assertion-type"},Ms={class:"assertion-detail"},Fs={key:1,class:"detail-section error-section"},Is={class:"error-text"},Vs={class:"flex justify-center mt-4"},js={__name:"ApiTest",setup(Hs){const b=xe(),h=_(1),J=_(!1),B=_([]),k=_([]),O=_(""),ie=ze(()=>{if(!O.value)return B.value;const l=O.value.toLowerCase();return B.value.filter(e=>e.title.toLowerCase().includes(l))}),ne=[{type:"selection"},{title:"ID",key:"id",width:60},{title:"标题",key:"title",ellipsis:{tooltip:!0}},{title:"模块",key:"module",width:100,ellipsis:{tooltip:!0}},{title:"优先级",key:"priority",width:80,render(l){const e={1:"error",2:"warning",3:"info",4:"default"},r={1:"P1",2:"P2",3:"P3",4:"P4"};return le(x,{type:e[l.priority]||"default",size:"small"},{default:()=>r[l.priority]||l.priority})}},{title:"类型",key:"case_type",width:90,ellipsis:{tooltip:!0}}],oe=async()=>{J.value=!0;try{const l=await he.getList({limit:500});B.value=l.data||l.test_cases||[]}catch{b.error("加载用例失败")}finally{J.value=!1}},P=_(!1),v=_(null),C=_(null),de=[{title:"Method",key:"method",width:90,render(l){return le(x,{type:M(l.method),size:"small"},{default:()=>l.method})}},{title:"Path",key:"path",ellipsis:{tooltip:!0}},{title:"Summary",key:"summary",ellipsis:{tooltip:!0}}],M=l=>({GET:"success",POST:"warning",PUT:"info",DELETE:"error",PATCH:"default"})[l]||"default",re=async()=>{var l,e;h.value=2,P.value=!0,v.value=null;try{const r=await F.matchSpec(k.value);r.success?(v.value=r.data,C.value=r.data.recommended.spec_version_id):b.error(r.message||"匹配失败")}catch(r){b.error(((e=(l=r.response)==null?void 0:l.data)==null?void 0:e.detail)||r.message||"匹配失败")}finally{P.value=!1}},ue=l=>{if(C.value=l.spec_version_id,v.value){const e=v.value.recommended;v.value.recommended={...l,confidence:l.confidence||.5,reason:"用户手动选择"},v.value.candidates=v.value.candidates.filter(r=>r.spec_version_id!==l.spec_version_id),v.value.candidates.unshift({spec_version_id:e.spec_version_id,original_filename:e.original_filename,minio_key:e.minio_key,service_name:e.service_name,endpoint_count:e.endpoint_count,confidence:e.confidence,reason:e.reason})}},N=_(!1),m=_(null),E=_("llm_enhanced"),w=_({base_url:"http://localhost:8080",headersStr:""}),S=_([]),y=_({}),L=_(!1),ce=l=>{const e=B.value.find(r=>r.id===l);return e?e.title:`用例 ${l}`},ve=async()=>{L.value=!0;try{const l=await F.matchEndpoints(k.value,C.value);l.success?(y.value=l.data.case_endpoint_map||{},h.value=3):(b.warning(l.message||"接口匹配失败，将使用全量匹配"),y.value={},h.value=3)}catch{b.warning("接口匹配失败，将使用全量匹配"),y.value={},h.value=3}finally{L.value=!1}},pe=l=>{const e=S.value.indexOf(l);e>=0?S.value.splice(e,1):S.value.push(l)},fe=l=>{try{return typeof l=="string"?l:JSON.stringify(l,null,2)}catch{return String(l)}},me=l=>{if(!l)return"-";try{const e=JSON.parse(l);return JSON.stringify(e,null,2)}catch{return l}},_e=async()=>{var e,r;N.value=!0,m.value=null,S.value=[];let l=null;if(w.value.base_url){let t={};if(w.value.headersStr)try{t=JSON.parse(w.value.headersStr)}catch{}l={base_url:w.value.base_url,headers:t}}try{const t=await F.execute(k.value,C.value,l,E.value,Object.keys(y.value).length>0?y.value:null);if(t.success){m.value=t.data,t.data.results.forEach((A,R)=>{A.status==="fail"&&S.value.push(R)});const f=t.data.summary;f.fail===0?b.success(`全部通过 (${f.total} 条)`):b.warning(`通过 ${f.pass}，失败 ${f.fail}`)}else b.error(t.message||"执行失败")}catch(t){b.error(((r=(e=t.response)==null?void 0:e.data)==null?void 0:r.detail)||t.message||"执行失败")}finally{N.value=!1}},ye=()=>{h.value=1,k.value=[],v.value=null,C.value=null,m.value=null,S.value=[],E.value="llm_enhanced",y.value={}};return be(oe),(l,e)=>(u(),c("div",Te,[n(i(z),{class:"mb-4"},{header:a(()=>[...e[7]||(e[7]=[s("div",{class:"flex items-center gap-2"},[s("i",{class:"fas fa-plug text-xl",style:{color:"#007857"}}),s("span",{class:"text-lg font-bold"},"接口测试")],-1)])]),default:a(()=>[n(i(we),{current:h.value,size:"small"},{default:a(()=>[n(i(I),{title:"选择用例",description:"勾选要测试的用例"}),n(i(I),{title:"智能匹配",description:"AI 匹配接口文件"}),n(i(I),{title:"执行测试",description:"确认并执行"})]),_:1},8,["current"])]),_:1}),h.value===1?(u(),c("div",qe,[n(i(z),null,{header:a(()=>[...e[8]||(e[8]=[d("选择测试用例",-1)])]),"header-extra":a(()=>[n(i(T),{type:"primary",disabled:k.value.length===0,onClick:re},{icon:a(()=>[...e[9]||(e[9]=[s("i",{class:"fas fa-arrow-right"},null,-1)])]),default:a(()=>[e[10]||(e[10]=d(" 下一步：智能匹配 ",-1))]),_:1},8,["disabled"])]),default:a(()=>[s("div",Be,[n(i(V),{value:O.value,"onUpdate:value":e[0]||(e[0]=r=>O.value=r),placeholder:"搜索用例标题...",clearable:"",style:{width:"280px"}},{prefix:a(()=>[...e[11]||(e[11]=[s("i",{class:"fas fa-search text-gray-400"},null,-1)])]),_:1},8,["value"]),s("span",Oe,"已选 "+o(k.value.length)+" 条",1)]),n(i(Z),{show:J.value},{default:a(()=>[n(i(ee),{columns:ne,data:ie.value,"row-key":r=>r.id,"checked-row-keys":k.value,"onUpdate:checkedRowKeys":e[1]||(e[1]=r=>k.value=r),"max-height":480,size:"small",striped:""},null,8,["data","row-key","checked-row-keys"])]),_:1},8,["show"])]),_:1})])):p("",!0),h.value===2?(u(),c("div",Pe,[n(i(z),null,{header:a(()=>[...e[12]||(e[12]=[d("智能匹配结果",-1)])]),"header-extra":a(()=>[s("div",Ee,[n(i(T),{onClick:e[2]||(e[2]=r=>h.value=1)},{icon:a(()=>[...e[13]||(e[13]=[s("i",{class:"fas fa-arrow-left"},null,-1)])]),default:a(()=>[e[14]||(e[14]=d("上一步 ",-1))]),_:1}),n(i(T),{type:"primary",disabled:!v.value,loading:L.value,onClick:ve},{icon:a(()=>[...e[15]||(e[15]=[s("i",{class:"fas fa-arrow-right"},null,-1)])]),default:a(()=>[d(o(L.value?"匹配接口中...":"下一步：确认执行")+" ",1)]),_:1},8,["disabled","loading"])])]),default:a(()=>[n(i(Z),{show:P.value},{default:a(()=>{var r;return[v.value?(u(),c("div",Le,[e[21]||(e[21]=s("div",{class:"match-label"},[s("i",{class:"fas fa-star",style:{color:"#f59e0b"}}),d(" AI 推荐接口文件")],-1)),s("div",Ae,[s("div",Re,[e[16]||(e[16]=s("div",{class:"match-icon"},[s("i",{class:"fas fa-file-alt"})],-1)),s("div",Ue,[s("h4",null,o(v.value.recommended.original_filename),1),s("span",De,o(v.value.recommended.service_name||"default"),1)]),n(i(x),{type:"success",size:"small"},{default:a(()=>[d("置信度 "+o((v.value.recommended.confidence*100).toFixed(0))+"%",1)]),_:1})]),v.value.recommended.reason?(u(),c("p",$e,[e[17]||(e[17]=s("i",{class:"fas fa-lightbulb text-yellow-500"},null,-1)),d(" "+o(v.value.recommended.reason),1)])):p("",!0),s("div",Je,o(v.value.recommended.endpoint_count)+" 个接口",1)]),(r=v.value.candidates)!=null&&r.length?(u(),c("div",Me,[e[19]||(e[19]=s("div",{class:"match-label"},[s("i",{class:"fas fa-list text-gray-400"}),d(" 其他候选")],-1)),s("div",Fe,[(u(!0),c(U,null,D(v.value.candidates,t=>(u(),c("div",{key:t.spec_version_id,class:q(["match-card candidate",{active:C.value===t.spec_version_id}]),onClick:f=>ue(t)},[s("div",Ve,[e[18]||(e[18]=s("div",{class:"match-icon small"},[s("i",{class:"fas fa-file"})],-1)),s("div",je,[s("h4",null,o(t.original_filename),1)]),n(i(x),{size:"small"},{default:a(()=>[d(o(t.endpoint_count)+" 接口",1)]),_:2},1024)])],10,Ie))),128))])])):p("",!0),s("div",He,[e[20]||(e[20]=s("div",{class:"match-label"},[s("i",{class:"fas fa-eye text-blue-500"}),d(" 接口预览")],-1)),n(i(ee),{columns:de,data:v.value.preview_endpoints||[],size:"small","max-height":240,striped:""},null,8,["data"])])])):P.value?p("",!0):(u(),c("div",Ge,[...e[22]||(e[22]=[s("i",{class:"fas fa-robot text-4xl mb-4 block"},null,-1),s("p",null,"正在等待匹配...",-1)])]))]}),_:1},8,["show"])]),_:1})])):p("",!0),h.value===3?(u(),c("div",Qe,[n(i(z),null,{header:a(()=>[...e[23]||(e[23]=[d("确认执行",-1)])]),"header-extra":a(()=>[s("div",Ke,[n(i(T),{onClick:e[3]||(e[3]=r=>h.value=2),disabled:N.value},{icon:a(()=>[...e[24]||(e[24]=[s("i",{class:"fas fa-arrow-left"},null,-1)])]),default:a(()=>[e[25]||(e[25]=d("上一步 ",-1))]),_:1},8,["disabled"]),n(i(T),{type:"primary",loading:N.value,disabled:N.value,onClick:_e},{icon:a(()=>[...e[26]||(e[26]=[s("i",{class:"fas fa-play"},null,-1)])]),default:a(()=>[d(" "+o(N.value?"执行中...":"开始执行"),1)]),_:1},8,["loading","disabled"])])]),default:a(()=>{var r;return[m.value?p("",!0):(u(),c("div",We,[n(i(Se),{column:2,"label-placement":"left",bordered:"",size:"small",class:"mb-4"},{default:a(()=>[n(i($),{label:"选中用例"},{default:a(()=>[d(o(k.value.length)+" 条",1)]),_:1}),n(i($),{label:"接口文件"},{default:a(()=>{var t,f;return[d(o(((f=(t=v.value)==null?void 0:t.recommended)==null?void 0:f.original_filename)||"-"),1)]}),_:1}),n(i($),{label:"执行模式"},{default:a(()=>[n(i(Ce),{value:E.value,"onUpdate:value":e[4]||(e[4]=t=>E.value=t),size:"small"},{default:a(()=>[n(i(se),{value:"llm_enhanced"},{default:a(()=>[...e[27]||(e[27]=[d("LLM 增强",-1)])]),_:1}),n(i(se),{value:"smoke_only"},{default:a(()=>[...e[28]||(e[28]=[d("冒烟测试",-1)])]),_:1})]),_:1},8,["value"])]),_:1}),n(i($),{label:"接口数"},{default:a(()=>{var t,f;return[d(o(Object.keys(y.value).length||((f=(t=v.value)==null?void 0:t.recommended)==null?void 0:f.endpoint_count)||0)+" 个匹配",1)]}),_:1})]),_:1}),n(i(z),{size:"small",class:"mb-4"},{header:a(()=>[...e[29]||(e[29]=[s("span",{class:"text-sm"},[s("i",{class:"fas fa-link mr-1",style:{color:"#007857"}}),d(" 用例-接口匹配（AI 预匹配）")],-1)])]),default:a(()=>[s("div",Xe,[(u(!0),c(U,null,D(k.value,t=>(u(),c("div",{key:t,class:"mapping-row"},[s("div",Ye,[s("span",Ze,"#"+o(t),1),s("span",es,o(ce(t)),1)]),e[30]||(e[30]=s("i",{class:"fas fa-arrow-right text-gray-300 mx-2"},null,-1)),y.value[String(t)]?(u(),c("div",ss,[n(i(x),{type:M(y.value[String(t)].method),size:"small"},{default:a(()=>[d(o(y.value[String(t)].method),1)]),_:2},1032,["type"]),s("code",ts,o(y.value[String(t)].path),1),s("span",as,o(y.value[String(t)].summary),1)])):(u(),c("div",ls,"未匹配"))]))),128)),k.value.length?p("",!0):(u(),c("div",is,"暂无用例"))])]),_:1}),n(i(z),{size:"small",title:"环境配置",class:"mb-4",style:{"max-width":"700px"}},{default:a(()=>[n(i(Ne),{"label-placement":"left","label-width":"80",size:"small"},{default:a(()=>[n(i(te),{label:"Base URL"},{default:a(()=>[n(i(V),{value:w.value.base_url,"onUpdate:value":e[5]||(e[5]=t=>w.value.base_url=t),placeholder:"http://localhost:8080"},null,8,["value"])]),_:1}),n(i(te),{label:"Headers"},{default:a(()=>[n(i(V),{value:w.value.headersStr,"onUpdate:value":e[6]||(e[6]=t=>w.value.headersStr=t),type:"textarea",rows:2,placeholder:'{"Authorization": "Bearer xxx"}'},null,8,["value"])]),_:1})]),_:1})]),_:1})])),m.value?(u(),c("div",ns,[s("div",os,[s("div",ds,[s("span",rs,o(m.value.summary.total),1),e[31]||(e[31]=s("span",{class:"result-stat-label"},"总计",-1))]),s("div",us,[s("span",cs,o(m.value.summary.pass),1),e[32]||(e[32]=s("span",{class:"result-stat-label"},"通过",-1))]),s("div",vs,[s("span",ps,o(m.value.summary.fail),1),e[33]||(e[33]=s("span",{class:"result-stat-label"},"失败",-1))]),s("div",fs,[s("span",ms,o(m.value.summary.pass_rate)+"%",1),e[34]||(e[34]=s("span",{class:"result-stat-label"},"通过率",-1))]),s("div",_s,[s("span",ys,o(m.value.summary.duration)+"s",1),e[35]||(e[35]=s("span",{class:"result-stat-label"},"耗时",-1))])]),s("div",gs,[m.value.report_id?(u(),ae(i(x),{key:0,type:"info",size:"small"},{default:a(()=>[e[36]||(e[36]=s("i",{class:"fas fa-file-alt mr-1"},null,-1)),d(" 报告 #"+o(m.value.report_id),1)]),_:1})):p("",!0),(r=m.value.bug_report_ids)!=null&&r.length?(u(),ae(i(x),{key:1,type:"error",size:"small"},{default:a(()=>[e[37]||(e[37]=s("i",{class:"fas fa-bug mr-1"},null,-1)),d(" "+o(m.value.bug_report_ids.length)+" 个 Bug ",1)]),_:1})):p("",!0)]),(u(!0),c(U,null,D(m.value.results,(t,f)=>{var A,R,j,H,G,Q,K,W,X,Y;return u(),c("div",{key:t.record_id,class:q(["result-card",t.status])},[s("div",{class:"result-card-header",onClick:g=>pe(f)},[s("div",ks,[n(i(x),{type:t.status==="pass"?"success":"error",size:"small"},{default:a(()=>[d(o(t.status==="pass"?"通过":"失败"),1)]),_:2},1032,["type"]),s("span",xs,o(t.title),1)]),s("div",bs,[s("code",ws,[n(i(x),{type:M((A=t.endpoint)==null?void 0:A.method),size:"tiny"},{default:a(()=>{var g;return[d(o(((g=t.endpoint)==null?void 0:g.method)||"?"),1)]}),_:2},1032,["type"]),d(" "+o(((R=t.endpoint)==null?void 0:R.path)||"-"),1)]),s("span",Ss,o(t.duration)+"s",1),s("i",{class:q([S.value.includes(f)?"fas fa-chevron-up":"fas fa-chevron-down","text-gray-400"])},null,2)])],8,hs),S.value.includes(f)?(u(),c("div",Cs,[s("div",Ns,[e[42]||(e[42]=s("div",{class:"detail-label"},[s("i",{class:"fas fa-paper-plane text-blue-500"}),d(" 请求")],-1)),s("div",zs,[e[38]||(e[38]=s("span",{class:"detail-key"},"URL",-1)),s("code",Ts,o(((j=t.request_info)==null?void 0:j.url)||"-"),1)]),(H=t.request_info)!=null&&H.query_params&&Object.keys(t.request_info.query_params).length?(u(),c("div",qs,[e[39]||(e[39]=s("span",{class:"detail-key"},"Query",-1)),s("code",Bs,o(JSON.stringify(t.request_info.query_params)),1)])):p("",!0),(G=t.request_info)!=null&&G.body?(u(),c("div",Os,[e[40]||(e[40]=s("span",{class:"detail-key"},"Body",-1)),s("pre",Ps,o(fe(t.request_info.body)),1)])):p("",!0),(Q=t.request_info)!=null&&Q.headers&&Object.keys(t.request_info.headers).length?(u(),c("div",Es,[e[41]||(e[41]=s("span",{class:"detail-key"},"Headers",-1)),s("code",Ls,o(JSON.stringify(t.request_info.headers)),1)])):p("",!0)]),s("div",As,[e[45]||(e[45]=s("div",{class:"detail-label"},[s("i",{class:"fas fa-reply text-green-500"}),d(" 响应")],-1)),s("div",Rs,[e[43]||(e[43]=s("span",{class:"detail-key"},"Status",-1)),n(i(x),{type:((K=t.response_info)==null?void 0:K.status_code)>=200&&((W=t.response_info)==null?void 0:W.status_code)<300?"success":"error",size:"small"},{default:a(()=>{var g;return[d(o(((g=t.response_info)==null?void 0:g.status_code)||"-"),1)]}),_:2},1032,["type"])]),(X=t.response_info)!=null&&X.body_trunc?(u(),c("div",Us,[e[44]||(e[44]=s("span",{class:"detail-key"},"Body",-1)),s("pre",Ds,o(me(t.response_info.body_trunc)),1)])):p("",!0)]),(Y=t.assertions)!=null&&Y.length?(u(),c("div",$s,[e[48]||(e[48]=s("div",{class:"detail-label"},[s("i",{class:"fas fa-check-double text-purple-500"}),d(" 断言")],-1)),(u(!0),c(U,null,D(t.assertions,(g,ge)=>(u(),c("div",{key:ge,class:q(["assertion-row",g.passed?"passed":"failed"])},[s("i",{class:q(g.passed?"fas fa-check-circle text-green-500":"fas fa-times-circle text-red-500")},null,2),s("span",Js,o(g.type),1),s("span",Ms,[e[46]||(e[46]=d("期望: ",-1)),s("code",null,o(g.expected),1),e[47]||(e[47]=d(" 实际: ",-1)),s("code",null,o(g.actual),1)])],2))),128))])):p("",!0),t.error_message?(u(),c("div",Fs,[e[49]||(e[49]=s("div",{class:"detail-label"},[s("i",{class:"fas fa-exclamation-triangle text-red-500"}),d(" 错误")],-1)),s("div",Is,o(t.error_message),1)])):p("",!0)])):p("",!0)],2)}),128)),s("div",Vs,[n(i(T),{onClick:ye},{icon:a(()=>[...e[50]||(e[50]=[s("i",{class:"fas fa-redo"},null,-1)])]),default:a(()=>[e[51]||(e[51]=d("重新测试 ",-1))]),_:1})])])):p("",!0)]}),_:1})])):p("",!0)]))}},Ks=ke(js,[["__scopeId","data-v-a02b0b44"]]);export{Ks as default};
